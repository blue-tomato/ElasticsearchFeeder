(function(){CKEDITOR.plugins.add("pwimage",{requires:"dialog",init:function(c){var d="pwimage";var f="img[alt,id,!src,title,width](align_left,align_center,align_right,hidpi,align-left,align-center,align-right);a[!href];figure{width}(align_left,align_center,align_right,hidpi,align-left,align-center,align-right);figcaption;";var e="img[alt,src]";c.addCommand(d,{allowedContent:f,requiredContent:e,exec:b});c.ui.addButton("PWImage",{label:c.lang.common.image,command:d,hidpi:true,icon:(CKEDITOR.env.hidpi?this.path+"images/hidpi/pwimage.png":this.path+"images/pwimage.png")});c.on("doubleclick",function(g){var h=g.data.element;if((h.is("img"))&&!h.data("cke-realelement")&&!h.isReadOnly()){g.cancel();c.commands.pwimage.exec()}});if(c.addMenuItems){c.addMenuItems({image:{label:c.lang.image.menu,command:"pwimage",group:"image"}})}if(c.contextMenu){c.contextMenu.addListener(function(g,h){if(a(c,g)){return{image:CKEDITOR.TRISTATE_OFF}}})}}});function a(d,c){if(!c){var e=d.getSelection();c=e.getSelectedElement()}if(c&&c.is("img")&&!c.data("cke-realelement")&&!c.isReadOnly()){return c}}function b(h){var o=jQuery("#Inputfield_id");if(o.length){var p=o.val()}else{var p=jQuery("#"+h.name).closest(".Inputfield").attr("data-pid")}var j=p;var C="";var k="";var s=0;var B=0;var y="";var i="";var c=false;var F=h.getSelection();var G=F.getSelectedElement();var z=F.getStartElement();var D=jQuery(z);var g=z.getParent();var r=g.getParent();var m=D.attr("src");var q=null;var E=null;var v=null;var e=g.$.nodeName.toUpperCase();var l=r?r.$.nodeName.toUpperCase():"";if(typeof ckeGetProcessWireConfig!="undefined"){var A=ckeGetProcessWireConfig(h);if(A&&A.pwAssetPageID){p=A.pwAssetPageID}}F.lock();h.lockSelection();if(l=="FIGURE"){E=jQuery(r.getOuterHtml());v=E.find("figcaption");E.find("img").remove()}else{if(e=="FIGURE"){E=jQuery(g.getOuterHtml());v=E.find("figcaption");E.find("img").remove()}}if(e==="A"){q=jQuery(g.getOuterHtml());q.find("img").remove()}if(m){k=E?E.attr("class"):D.attr("class");c=k&&k.indexOf("hidpi")>-1;s=D.attr("width");B=D.attr("height");y=D.attr("alt");i=e==="A"?g.$.href:"";var x=m.split("/");C=x.pop();x=x.reverse();p="";for(var w=0;w<x.length;w++){if(x[w].match(/^\d+$/)){p=x[w]+p}else{if(p.length){break}}}p=parseInt(p)}var t=ProcessWire.config.urls.admin+"page/image/";var f="?id="+p+"&edit_page_id="+j+"&modal=1";if(C.length){f+="&file="+C}if(s){f+="&width="+s}if(B){f+="&height="+B}if(k&&k.length){f+="&class="+encodeURIComponent(k)}f+="&hidpi="+(c?"1":"0");if(y&&y.length){f+="&description="+encodeURIComponent(y)}if(v){f+="&caption=1"}if(i&&i.length){f+="&link="+encodeURIComponent(i)}f+=("&winwidth="+(jQuery(window).width()-30));var d={title:"<i class='fa fa-fw fa-folder-open'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.selectLabel,open:function(){if(jQuery(".cke_maximized").length>0){jQuery(".ui-dialog").css("z-index",9999);jQuery(".ui-widget-overlay").css("z-index",9998)}}};var u=pwModalWindow(t+f,d,"large");u.load(function(){var I=u.contents();if(I.find("#selected_image").length>0){var n=[{html:"<i class='fa fa-camera'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.insertBtn,click:function(){function O(U){var ae=u.contents();var V=jQuery("#selected_image",ae);var W=V.attr("width");var af=V.attr("height");var aa=jQuery("#selected_image_description",ae).val();var ah=jQuery("#selected_image_caption",ae).is(":checked")?true:false;var ad=jQuery("#selected_image_hidpi",ae).is(":checked")?true:false;var ag=V.removeClass("ui-resizable No Alignment resizable_setup").removeClass("rotate90 rotate180 rotate270 rotate-90 rotate-180 rotate-270").removeClass("flip_vertical flip_horizontal").attr("class");var T=jQuery("#selected_image_link",ae);var ab=T.is(":checked")?T.val():"";var ac=jQuery("<img />").attr("src",U).attr("alt",aa);if(ad){ag+=(ag.length>0?" ":"")+"hidpi"}if(ah===false){ac.addClass(ag)}if(W>0&&V.attr("data-nosize")!="1"){ac.attr("width",W)}if(q){if(ab&&ab.length>0){q.attr("href",ab).attr("data-cke-saved-href",ab)}else{if(T.attr("data-was-checked")==1){q=null}}if(q!==null){q.append(ac);ac=q}}else{if(ab&&ab.length>0){var Y=jQuery("<a />").attr("href",ab).append(ac);ac=Y}}if(ah){var X=jQuery("<figure />");if(ag.length){X.addClass(ag)}if(!v){v=jQuery("<figcaption />");if(aa.length>1){v.append(aa)}else{v.append(ProcessWire.config.InputfieldCKEditor.pwimage.captionLabel)}}if(v){X.append(v)}X.prepend(ac);ac=X}if(l==="FIGURE"){h.unlockSelection();F.unlock();F.selectElement(r)}else{if(e==="A"||e=="FIGURE"){h.unlockSelection();F.unlock();F.selectElement(g)}}var Z=ac[0].outerHTML;h.insertHtml(Z);h.fire("change");u.dialog("close")}var Q=u.contents();var J=jQuery("#selected_image",Q);u.dialog("disable");u.setTitle("<i class='fa fa-fw fa-spin fa-spinner'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.savingNote);J.removeClass("resized");var K=J.attr("width");if(!K){K=J.width()}var R=J.attr("height");if(!R){R=J.height()}var L=J.attr("src");var S=jQuery("#page_id",Q).val();var P=jQuery("#selected_image_hidpi",Q).is(":checked")?1:0;var N=parseInt(jQuery("#selected_image_rotate",Q).val());L=L.substring(L.lastIndexOf("/")+1);var M=t+"resize?id="+S+"&file="+L+"&width="+K+"&height="+R+"&hidpi="+P;if(N){M+="&rotate="+N}if(J.hasClass("flip_horizontal")){M+="&flip=h"}else{if(J.hasClass("flip_vertical")){M+="&flip=v"}}jQuery.get(M,function(U){var T=jQuery("<div></div>").html(U);var V=T.find("#selected_image").attr("src");O(V)})}},{html:"<i class='fa fa-folder-open'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.selectBtn,"class":"ui-priority-secondary",click:function(){var K=u.contents();var J=jQuery("#page_id",K).val();u.attr("src",t+"?id="+J+"&modal=1");u.setButtons({})}},{html:"<i class='fa fa-times-circle'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.cancelBtn,"class":"ui-priority-secondary",click:function(){u.dialog("close")}}];u.setButtons(n);u.setTitle("<i class='fa fa-fw fa-picture-o'></i> "+I.find("title").html())}else{var n=[];jQuery("button.pw-modal-button, button[type=submit]:visible",I).each(function(){var K=jQuery(this);var J={html:K.html(),click:function(){K.click()}};n.push(J);if(!K.hasClass("pw-modal-button-visible")){K.hide()}});var H={html:"<i class='fa fa-times-circle'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.cancelBtn,"class":"ui-priority-secondary",click:function(){u.dialog("close")}};n.push(H);u.setButtons(n)}})}})();